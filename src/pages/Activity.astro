---
import Layout from "../layouts/Layout.astro";
import "../styles/UA+reset.css";
import "../styles/Activity.css";
import { microcmsClient } from "../lib/microcms";
import type { Blog, Tag } from "../types/microcms";
import { buildTabs, formatDate, getPublishedDate, normalizeTags } from "../utils/blog";

const { contents: posts } = await microcmsClient.getList<Blog>({
  endpoint: "blog",
  queries: {
    limit: 100,
    orders: "-publishedAt",
    depth: 2,
  },
});

const { contents: tags } = await microcmsClient.getList<Tag>({
  endpoint: "blog-tags",
  queries: {
    limit: 100,
    orders: "name",
  },
});

const tabs = buildTabs(posts, tags);
---

<Layout>
  <Fragment slot="main-slot">
    <div class="section-title a-anchor">
      <h1>Activity</h1>
      <div class="section-title-line"></div>
    </div>
  </Fragment>
  <Fragment slot="menu-slot"></Fragment>
  <Fragment slot="body-slot">
    <div class="tab">
      {tabs.map((tab, index) => {
        const inputId = `tab-${tab.slug}`;
        return [
          <input type="radio" id={inputId} name="tab" checked={index === 0} />,
          <label for={inputId}>{tab.label}</label>,
          <div class="tab-panel">
            {tab.posts.length ? (
              tab.posts.map((post) => (
                <article class="Activity-item">
                  <div class="Activity-info">
                    <p class="Activity-date">{formatDate(getPublishedDate(post))}</p>
                    {normalizeTags(post.tags).map((tag) => (
                      <span class="Activity-tag">
                        #{tag.name}
                      </span>
                    ))}
                  </div>
                  <h2 class="Activity-title">
                    <a href={`/posts/${post.slug}/`}>{post.title}</a>
                  </h2>
                  {post.excerpt ? (
                    <p class="Activity-excerpt">{post.excerpt}</p>
                  ) : null}
                </article>
              ))
            ) : (
              <p class="Activity-empty">該当する記事はまだありません。</p>
            )}
          </div>,
        ];
      })}
    </div>
  </Fragment>
</Layout>
