---
import Layout from "../layouts/Layout.astro";
import "../styles/UA+reset.css";
import "../styles/Gallery.css";
import { getAlbums, getAlbumCoverId } from "../lib/lightroom";
const rawAlbums = await getAlbums();

const albums = await Promise.all(
  rawAlbums.map(async (album) => {
    const coverId = await getAlbumCoverId(album.id);

    return {
      ...album,
      coverId, 
    };
  })
);
const years = Array.from(
  new Set(
    albums.map((item) => {
      return item.created
        ? new Date(item.created).getFullYear()
        : new Date().getFullYear();
    }),
  ),
).sort((a, b) => b - a);

const tabYears = ["All", ...years];
const categories = ["撮影会", "合宿", "展示", "その他"];
const getCategoryFromName = (name: string) => {
  if (name.includes("撮影会")) return "撮影会";
  if (name.includes("合宿")) return "合宿";
  if (name.includes("展示")) return "展示";
  return "その他";
};
---

<Layout>
  <Fragment slot="main-slot">
    <div class="section-title">
        <h1>Gallery</h1>
        <div class="section-title-line"></div>
      </div>
  </Fragment>
  <Fragment slot="menu-slot">
    <div class="menu-contents-inner">
      <a href="#" class="page-top-nav">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          ><path
            fill="currentColor"
            d="M16 21.308L6.692 12L16 2.692l1.064 1.064L8.819 12l8.244 8.244z"
          ></path></svg
        >
      </a>
    </div>
  </Fragment>
  <Fragment slot="body-slot">
    <div class="explanation-area">
      <p>
        サークルの普段の活動を各イベントごとにアルバムで分類しています。
      </p>
    </div>
    <div class="tab">
      {
        tabYears.map((year, index) => {
          const inputId = `year-${year}`;
          return [
            <input type="radio" id={inputId} name="year" checked={index === 0} />,
            <label for={inputId}>{year}</label>,
            <div class="tab-panel">
              <div class="gallery-content">
                {categories.map((category) => (
                  <details class="category-section" name="category-section">
                    <summary class="category-title">
                      <img class="arrow-icon" src="/icons/rightarrow.svg" alt="arrow icon"> {category}
                    </summary>
                    <div class="gallery-grid">
                      {albums.map((item) => {
                        const itemYear = item.created ? new Date(item.created).getFullYear() : new Date().getFullYear();
                        const itemCategory = getCategoryFromName(item.payload.name);
                        const showByYear = year === "All" || `${itemYear}` === `${year}`;
                        if (!showByYear || itemCategory !== category) return null;
                        return (
                          <div class="gallery-item" data-year={itemYear}>
                            <a href={`/Gallery/${item.id}`} class="gallery-link">
                              <div class="image-wrapper">
                                {item.coverId ? (
                                  <img
                                    src={`/api/images/${item.coverId}`}
                                    alt={item.payload.name}
                                    loading="lazy"
                                  />
                                ) : (
                                  <div class="placeholder-image">
                                    <span>No Image</span>
                                  </div>
                                )}
                                <p class="image-title">{item.payload.name}</p>
                              </div>
                            </a>
                          </div>
                        );
                      })}
                    </div>
                  </details>
                ))}
              </div>
            </div>,
          ];
        })
      }
    </div>
  </Fragment>
</Layout>

<script>
  const tabs = document.querySelectorAll(".year-tab");
  
  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      tabs.forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");

      const selectedYear = tab.getAttribute("data-year");
      const items = document.querySelectorAll(".gallery-item");

      items.forEach((item) => {
        const itemYear = item.getAttribute("data-year");

        if (selectedYear === "All" || itemYear === selectedYear) {
          (item as HTMLElement).style.display = "block";
        } else {
          (item as HTMLElement).style.display = "none";
        }
      });
    });
  });

  const details = document.querySelectorAll("details");
  details.forEach((detail) => {
    const updateArrow = () => {
      const arrow = detail.querySelector(".arrow-icon");
      if (arrow) arrow.textContent = detail.open ? "▽" : "▷";
    };
    detail.addEventListener("toggle", updateArrow);
    updateArrow();
  });
</script>
