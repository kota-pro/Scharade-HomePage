---
import Layout from "../layouts/Layout.astro";
import "../styles/UA+reset.css";
import "../styles/Portfolio.css";

// ★追加：microCMSからデータを取得する関数をインポート
import { getPortfolios } from "../lib/microcms";

// フィルター用タブの項目
const tabs = [
  "All",
  "1st Grade",
  "2nd Grade",
  "3rd Grade",
  "4th Grade",
  "Master",
  "International",
  "Graduate",
];

// ★修正：microCMSから一覧データを取得
// 表示に必要なフィールドだけ指定して取得します
const response = await getPortfolios({
  fields: ["id", "name", "grade", "icon"],
  limit: 100, // とりあえず100件まで（必要に応じて調整）
});
const portfolios = response.contents;
---

<Layout title="Sharade | Portfolio">
  <Fragment slot="main-slot">
    <div class="portfolio-container">
      
      {/* タイトルセクション */}
      <div class="section-title">
        <h1>Portfolio</h1>
        <div class="section-title-line"></div>
      </div>

      <p class="page-description">
        サークル員のポートフォリオになります。ぜひご鑑賞ください。
      </p>

      {/* フィルタータブ */}
      <div class="filter-tabs-wrapper">
        <ul class="filter-tabs">
          {tabs.map((tab, index) => (
            <li class={`filter-tab ${index === 0 ? "active" : ""}`}>
              {tab}
            </li>
          ))}
        </ul>
        <div class="tabs-border-line"></div>
      </div>

      {/* ページネーション（上） */}
      <div class="pagination top">
        <span class="page-arrow">◁</span>
        <span class="page-count">1 / {portfolios.length}</span>
        <span class="page-arrow">▷</span>
      </div>

      {/* メンバーリスト（アコーディオン） */}
      <details class="member-section" open>
        <summary class="section-heading">
          <span class="arrow-icon">▷</span> All Members
        </summary>
        
        <div class="member-grid">
          {/* ★修正：microCMSのデータを表示 */}
          {portfolios.map((portfolio) => (
            /* 詳細ページへのリンクに変更（aタグ） */
            <a href={`/portfolio/${portfolio.id}`} class="member-card" style="display: block; text-decoration: none; color: inherit;">
              <div class="member-image-placeholder">
                 {/* アイコン画像があれば表示、なければグレーのまま */}
                 {portfolio.icon ? (
                    <img 
                      src={portfolio.icon.url} 
                      alt={portfolio.name}
                      style="width: 100%; height: 100%; object-fit: cover;"
                    />
                 ) : null}
              </div>
              
              <div class="member-info">
                <span class="member-grade">{portfolio.grade}</span>
                <span class="member-name">{portfolio.name}</span>
              </div>
            </a>
          ))}
        </div>
      </details>

      {/* ページネーション（下） */}
      <div class="pagination bottom">
        <span class="page-arrow">◁</span>
        <span class="page-arrow">◁</span>
        <span class="page-number">1</span>
        {/* 以下略...実装時はロジックが必要ですが一旦そのまま */}
        <span class="page-dots">...</span>
        <span class="page-arrow">▷</span>
        <span class="page-arrow">▷</span>
      </div>

    </div>
  </Fragment>
</Layout>

<script>
  // アコーディオンの矢印切り替えロジック
  const details = document.querySelectorAll("details");
  details.forEach((detail) => {
    const summary = detail.querySelector("summary");
    const arrow = summary?.querySelector(".arrow-icon");
    
    if(arrow) {
        detail.addEventListener("toggle", () => {
            arrow.textContent = detail.open ? "▽" : "▷";
        });
    }
  });

  // タブの切り替えロジック（見た目だけ）
  const tabs = document.querySelectorAll(".filter-tab");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
    });
  });
</script>